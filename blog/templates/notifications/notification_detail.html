{% extends "base.html" %}
{% load static %}
{% block content %}

<h1>{{ post.title }}</h1>
<p>por {{ post.author.username }} – {{ post.created|date:"d/m/Y H:i" }}</p>
<hr>

<!-- Contenido del post -->
<div class="post-content mb-4">
  {{ post.content|safe }}
</div>

<hr>

<!-- Comentarios -->
<h3>Comentarios</h3>

{% if comments %}
  {% for comment in comments %}
    <div class="comment border p-2 mb-3 d-flex" id="comment-{{ comment.id }}">
      <!-- Avatar -->
      <div class="me-2">
        {% if comment.author.profile.avatar %}
          <img src="{{ comment.author.profile.avatar.url }}"
               alt="avatar" width="40" height="40" class="rounded-circle">
        {% else %}
          <img src="{% static 'img/default-avatar.png' %}"
               alt="avatar" width="40" height="40" class="rounded-circle">
        {% endif %}
      </div>

      <!-- Texto del comentario -->
      <div>
        <p>
          <b>{{ comment.author }}</b> dijo:
          <br>
          {{ comment.text }}
        </p>

        <!-- Mostrar si es respuesta -->
        {% if comment.parent %}
          <small class="text-muted">
            En respuesta a {{ comment.parent.author.username }}
          </small>
        {% endif %}

        <!-- Botón Responder -->
        {% if user.is_authenticated %}
          <a href="#" class="reply-btn btn btn-sm btn-outline-primary mt-1"
             data-username="{{ comment.author.username }}"
             data-comment="{{ comment.id }}">
            Responder
          </a>
        {% endif %}
      </div>
    </div>
  {% endfor %}
{% else %}
  <p>No hay comentarios todavía. ¡Sé el primero en comentar!</p>
{% endif %}

<hr>

<!-- Formulario de nuevo comentario -->
{% if user.is_authenticated %}
  <h4>Deja un comentario</h4>
  <form method="post" action="{% url 'blog:add_comment' post.slug %}">
    {% csrf_token %}

    <textarea id="comment-textarea" name="text" rows="3" class="form-control mb-2"
              placeholder="Escribe tu comentario..." required></textarea>

    <!-- Campo oculto: se rellena al responder -->
    <input type="hidden" name="parent_id" id="parent-id">

    <button type="submit" class="btn btn-success">Comentar</button>
  </form>
{% else %}
  <p><a href="{% url 'blog:login' %}">Inicia sesión</a> para dejar un comentario.</p>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", function() {
  const buttons = document.querySelectorAll(".reply-btn");
  const textarea = document.querySelector("#comment-textarea");
  const parentInput = document.querySelector("#parent-id");

  buttons.forEach(btn => {
    btn.addEventListener("click", function(e) {
      e.preventDefault();
      const username = this.dataset.username;
      const commentId = this.dataset.comment;

      // Autocompletar el textarea con @usuario
      textarea.value = "@" + username + " " + textarea.value;
      textarea.focus();

      // Guardar el comentario padre en el input hidden
      parentInput.value = commentId;
    });
  });
});
</script>

{% endblock %}
