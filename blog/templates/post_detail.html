{% extends 'base.html' %}
{% load static %}
{% block title %}{{ object.title }}{% endblock %}
{% block content %}
<article>
  <!-- T√≠tulo y autor -->
  <h1 class="mb-1">{{ object.title }}</h1>
  <small class="text-muted">
    por 
    <a href="{% url 'blog:profile_detail' object.author.username %}" class="text-decoration-none text-info">
      <strong>{{ object.author.username }}</strong>
    </a> 
    ¬∑ {{ object.created|date:"d/m/Y g:i a" }}

  </small>

  <!-- Promedio -->
  <div class="my-3">
    <strong>‚≠ê Promedio:</strong> 
    {% if object.average_rating %}
      <span class="text-warning" style="font-size:1.2rem;">
        {% for i in "12345" %}
          {% if forloop.counter <= object.average_rating|floatformat:0 %}
            ‚≠ê
          {% else %}
            ‚òÜ
          {% endif %}
        {% endfor %}
      </span>
      <span class="ms-2">
        ({{ object.average_rating|floatformat:1 }}/5 ¬∑ {{ object.total_reviews }} rese√±as)
      </span>
    {% else %}
      <span class="text-muted">Sin calificaciones a√∫n</span>
    {% endif %}
  </div>

  <!-- Imagen de portada -->
  {% if object.cover %}
    <img src="{{ object.cover.url }}" class="img-fluid my-3 rounded shadow-sm post-img" alt="cover">
  {% endif %}

  <!-- Contenido -->
  <div class="mt-3">{{ object.content|safe }}</div>

  <!-- Botones de autor -->
  {% if user == object.author %}
    <a href="{% url 'blog:post_update' object.slug %}" class="btn btn-sm btn-primary mt-2">‚úèÔ∏è Editar</a>
    <a href="{% url 'blog:post_delete' object.slug %}" class="btn btn-sm btn-danger mt-2">üóëÔ∏è Eliminar</a>
  {% endif %}

  <hr>

  <!-- Formulario de rese√±a -->
  <h4>Deja tu rese√±a</h4>
  {% if user.is_authenticated %}
    <form method="post" action="{% url 'blog:add_review' object.slug %}" class="mb-4">
      {% csrf_token %}
      <div class="mb-3">
        <label for="id_rating" class="form-label">Tu calificaci√≥n (1 a 5)</label>
        <select name="rating" id="id_rating" class="form-select" required>
          <option value="">Selecciona...</option>
          <option value="1">‚≠ê 1 - Muy malo</option>
          <option value="2">‚≠ê‚≠ê 2 - Malo</option>
          <option value="3">‚≠ê‚≠ê‚≠ê 3 - Regular</option>
          <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 - Bueno</option>
          <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 - Excelente</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="id_comment" class="form-label">Comentario</label>
        <textarea name="comment" id="id_comment" rows="3" class="form-control"
                  placeholder="Escribe tu opini√≥n..."></textarea>
      </div>
      <button class="btn btn-success w-100">Enviar</button>
    </form>
  {% else %}
    <p><a href="{% url 'blog:login' %}">Inicia sesi√≥n</a> para calificar y comentar.</p>
  {% endif %}

  <hr>

  <!-- Lista de rese√±as -->
  <h4>Rese√±as</h4>
  <ul class="list-unstyled">
    {% for r in reviews %}
      <div class="review border rounded p-3 mb-3 d-flex align-items-start">
        <!-- Avatar -->
        <div class="me-3">
          {% if r.user.profile.avatar %}
            <img src="{{ r.user.profile.avatar.url }}" alt="avatar" class="rounded-circle" width="48" height="48">
          {% else %}
            <img src="{% static 'img/default-avatar.png' %}" alt="avatar" class="rounded-circle" width="48" height="48">
          {% endif %}
        </div>

        <!-- Contenido de la rese√±a -->
        <div class="flex-grow-1">
          <p class="mb-1">{{ r.comment }}</p>
          <small class="text-warning">‚≠ê {{ r.rating }}/5</small><br>
          <small class="text-muted">
            Por 
            <a href="{% url 'blog:profile_detail' r.user.username %}" class="text-info fw-bold">
              {{ r.user.username|default:"An√≥nimo" }}
            </a>
            ‚Äì {{ r.created|date:"d/m/Y g:i A" }}
          </small>

          <!-- Moderaci√≥n de rese√±as -->
          {% if is_owner %}
            <div class="mt-2">
              <form method="post" action="{% url 'blog:moderate_review' r.id 'approve' %}" style="display:inline;">
                {% csrf_token %}<button class="btn btn-sm btn-success">Aprobar</button>
              </form>
              <form method="post" action="{% url 'blog:moderate_review' r.id 'hide' %}" style="display:inline;">
                {% csrf_token %}<button class="btn btn-sm btn-warning">Ocultar</button>
              </form>
              <form method="post" action="{% url 'blog:moderate_review' r.id 'block' %}" style="display:inline;">
                {% csrf_token %}<button class="btn btn-sm btn-danger">Bloquear</button>
              </form>
              <form method="post" action="{% url 'blog:moderate_review' r.id 'delete' %}" style="display:inline;">
                {% csrf_token %}<button class="btn btn-sm btn-dark">Eliminar</button>
              </form>
            </div>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <p class="text-muted">No hay rese√±as.</p>
    {% endfor %}
  </ul>

  <hr>

  <!-- Lista de comentarios -->
  <h4>Comentarios</h4>
  <ul class="list-unstyled">
    {% for c in comments %}
      <li class="comment border rounded p-2 mb-2">
        <p class="mb-1">{{ c.text }}</p>
        <small class="text-muted">
          Por {{ c.author|default:"An√≥nimo" }} ‚Äì {{ c.created|date:"d/m/Y g:i A" }}
        </small>
        <br>
        <small class="badge text-bg-secondary">Estado: {{ c.get_status_display }}</small>

        <!-- Moderaci√≥n de comentarios -->
        {% if is_owner %}
          <div class="mt-2">
            <form method="post" action="{% url 'blog:moderate_comment' c.id 'approve' %}" style="display:inline;">
              {% csrf_token %}<button class="btn btn-sm btn-success">Aprobar</button>
            </form>
            <form method="post" action="{% url 'blog:moderate_comment' c.id 'hide' %}" style="display:inline;">
              {% csrf_token %}<button class="btn btn-sm btn-warning">Ocultar</button>
            </form>
            <form method="post" action="{% url 'blog:moderate_comment' c.id 'block' %}" style="display:inline;">
              {% csrf_token %}<button class="btn btn-sm btn-danger">Bloquear</button>
            </form>
            <form method="post" action="{% url 'blog:moderate_comment' c.id 'delete' %}" style="display:inline;">
              {% csrf_token %}<button class="btn btn-sm btn-dark">Eliminar</button>
            </form>
          </div>
        {% endif %}
      </li>
    {% empty %}
      <p class="text-muted">No hay comentarios a√∫n.</p>
    {% endfor %}
  </ul>

</article>
{% endblock %}
