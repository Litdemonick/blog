{% extends 'base.html' %}
{% load static %}
{% block title %}{{ object.title }}{% endblock %}

{% block content %}
<article>
  <!-- T√≠tulo y autor -->
  <h1 class="mb-1">{{ object.title }}</h1>
  <div class="post-meta">
    por 
    <a href="{% url 'blog:profile_detail' object.author.username %}" class="username">
      <strong>{{ object.author.username }}</strong>
    </a> 
    ¬∑ {{ object.created|date:"d/m/Y g:i a" }}
  </div>

  <!-- Promedio -->
  <div class="my-3 rating">
    <strong>‚≠ê Promedio:</strong> 
    {% if object.average_rating %}
      <span style="font-size:1.2rem;">
        {% for i in "12345" %}
          {% if forloop.counter <= object.average_rating|floatformat:0 %}
            ‚≠ê
          {% else %}
            ‚òÜ
          {% endif %}
        {% endfor %}
      </span>
      <span class="ms-2">
        ({{ object.average_rating|floatformat:1 }}/5 ¬∑ {{ object.total_reviews }} rese√±as)
      </span>
    {% else %}
      <span>Sin calificaciones a√∫n</span>
    {% endif %}
  </div>

  <!-- Imagen de portada -->
  {% if object.cover %}
    <img src="{{ object.cover.url }}" class="img-fluid my-3 rounded shadow-sm post-img" alt="cover">
  {% endif %}

  <!-- Contenido -->
  <div class="mt-3">{{ object.content|safe }}</div>

  <!-- Botones de autor -->
  {% if user == object.author %}
    <a href="{% url 'blog:post_update' object.slug %}" class="btn btn-sm btn-primary mt-2">‚úèÔ∏è Editar</a>
    <a href="{% url 'blog:post_delete' object.slug %}" class="btn btn-sm btn-danger mt-2">üóëÔ∏è Eliminar</a>
  {% endif %}

  <hr>

  <!-- Formulario de rese√±a principal -->
  <h4>Deja tu rese√±a</h4>
  {% if user.is_authenticated %}
    <form method="post" action="{% url 'blog:add_review' object.slug %}" class="mb-4">
      {% csrf_token %}
      <div class="mb-3">
        <label for="id_rating" class="form-label">Tu calificaci√≥n (1 a 5)</label>
        <select name="rating" id="id_rating" class="form-select">
          <option value="">Selecciona...</option>
          <option value="1">‚≠ê 1 - Muy malo</option>
          <option value="2">‚≠ê‚≠ê 2 - Malo</option>
          <option value="3">‚≠ê‚≠ê‚≠ê 3 - Regular</option>
          <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 - Bueno</option>
          <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 - Excelente</option>
        </select>
      </div>
      <textarea name="comment" rows="3" class="form-control mb-2"
                placeholder="Escribe tu opini√≥n..." required></textarea>
      <button type="submit" class="btn btn-success w-100">Enviar</button>
    </form>
  {% else %}
    <p><a href="{% url 'blog:login' %}">Inicia sesi√≥n</a> para calificar y comentar.</p>
  {% endif %}

  <hr>

  <!-- Lista de rese√±as -->
  <h4>Rese√±as</h4>
  <ul class="list-unstyled">
    {% for r in reviews %}
      <div class="review border rounded p-3 mb-3 d-flex align-items-start" id="review-{{ r.id }}">
        <!-- Avatar -->
        <div class="me-3">
          {% if r.user.profile.avatar %}
            <img src="{{ r.user.profile.avatar.url }}" alt="avatar" class="rounded-circle" width="48" height="48">
          {% else %}
            <img src="{% static 'img/default-avatar.png' %}" alt="avatar" class="rounded-circle" width="48" height="48">
          {% endif %}
        </div>

        <!-- Contenido de la rese√±a -->
        <div class="flex-grow-1">
          <p class="mb-1">{{ r.comment }}</p>
          {% if r.rating %}
            <small class="rating">‚≠ê {{ r.rating }}/5</small><br>
          {% endif %}
          <small class="post-meta">
            Por 
            <a href="{% url 'blog:profile_detail' r.user.username %}" class="username fw-bold">
              {{ r.user.username|default:"An√≥nimo" }}
            </a>
            ‚Äì {{ r.created|date:"d/m/Y g:i A" }}
          </small>

          <!-- Bot√≥n Responder -->
          {% if user.is_authenticated %}
            <a href="#" 
               class="reply-toggle btn btn-sm btn-outline-primary mt-2"
               data-review="{{ r.id }}">
              Responder
            </a>
          {% endif %}

          <!-- Moderaci√≥n -->
          {% if is_owner %}
            <div class="mt-2">
              <form method="post" action="{% url 'blog:moderate_review' r.id 'approve' %}" style="display:inline;">
                {% csrf_token %}<button class="btn btn-sm btn-success">Aprobar</button>
              </form>
              <form method="post" action="{% url 'blog:moderate_review' r.id 'hide' %}" style="display:inline;">
                {% csrf_token %}<button class="btn btn-sm btn-warning">Ocultar</button>
              </form>
              <form method="post" action="{% url 'blog:moderate_review' r.id 'block' %}" style="display:inline;">
                {% csrf_token %}<button class="btn btn-sm btn-danger">Bloquear</button>
              </form>
              <form method="post" action="{% url 'blog:moderate_review' r.id 'delete' %}" style="display:inline;">
                {% csrf_token %}<button class="btn btn-sm btn-dark">Eliminar</button>
              </form>
            </div>
          {% endif %}

          <!-- Formulario inline oculto -->
          {% if user.is_authenticated %}
            <form method="post" action="{% url 'blog:add_review' object.slug %}" 
                  class="reply-form mt-2" id="reply-form-{{ r.id }}" style="display:none;">
              {% csrf_token %}
              <input type="hidden" name="parent_id" value="{{ r.id }}">
              <textarea name="comment" rows="2" class="form-control mb-2"
                        placeholder="Responde a {{ r.user.username }}..." required></textarea>
              <button type="submit" class="btn btn-sm btn-success">Enviar</button>
            </form>
          {% endif %}

          <!-- Bot√≥n Ver respuestas -->
          {% if r.replies.count > 0 %}
            <a href="#" class="toggle-replies d-block mt-2 text-primary small"
               data-review="{{ r.id }}">
              Ver {{ r.replies.count }} respuesta{{ r.replies.count|pluralize }}
            </a>

            <div class="replies-list ms-4 mt-2" id="replies-{{ r.id }}" style="display:none;">
              {% for reply in r.replies.all %}
                <div class="d-flex align-items-start mb-2 p-2 border-start">
                  <!-- Avatar respuesta -->
                  <div class="me-2">
                    {% if reply.user.profile.avatar %}
                      <img src="{{ reply.user.profile.avatar.url }}" alt="avatar" class="rounded-circle" width="32" height="32">
                    {% else %}
                      <img src="{% static 'img/default-avatar.png' %}" alt="avatar" class="rounded-circle" width="32" height="32">
                    {% endif %}
                  </div>
                  <!-- Contenido respuesta -->
                  <div>
                    <p class="mb-1">{{ reply.comment }}</p>
                    <small class="post-meta">
                      Por 
                      <a href="{% url 'blog:profile_detail' reply.user.username %}" class="username fw-bold">
                        {{ reply.user.username|default:"An√≥nimo" }}
                      </a>
                      ‚Äì {{ reply.created|date:"d/m/Y g:i A" }}
                    </small>

                    {% if user.is_authenticated %}
                      <a href="#" 
                         class="reply-toggle btn btn-sm btn-outline-primary ms-2"
                         data-review="{{ r.id }}">
                        Responder
                      </a>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <p class="post-meta">No hay rese√±as.</p>
    {% endfor %}
  </ul>

  <!-- Script -->
  <script>
  document.addEventListener("DOMContentLoaded", function() {
    // Toggle formulario de respuesta
    document.querySelectorAll(".reply-toggle").forEach(btn => {
      btn.addEventListener("click", function(e) {
        e.preventDefault();
        const form = document.getElementById("reply-form-" + this.dataset.review);
        if (form) {
          form.style.display = (form.style.display === "none" ? "block" : "none");
        }
      });
    });

    // Toggle Ver respuestas
    document.querySelectorAll(".toggle-replies").forEach(btn => {
      btn.addEventListener("click", function(e) {
        e.preventDefault();
        const repliesDiv = document.getElementById("replies-" + this.dataset.review);
        if (repliesDiv.style.display === "none") {
          repliesDiv.style.display = "block";
          this.textContent = "Ocultar respuestas";
        } else {
          repliesDiv.style.display = "none";
          const count = repliesDiv.children.length;
          this.textContent = `Ver ${count} respuesta${count > 1 ? "s" : ""}`;
        }
      });
    });
  });
  </script>

</article>
{% endblock %}
